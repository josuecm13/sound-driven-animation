/* CASO 5 */

(
/*
SONIDO DEL CARRO:
- Sonido de los frenos
- Sonido del choque
*/
~horn = {
	arg frequency, mul = 0.4, env;
	Mix.ar([LFSaw.ar(frequency, mul: mul),LFSaw.ar(frequency - 70 - 20.rand,  mul: mul)]) * env
};

~engine = {
	arg engineTime = 5, doneAction = 0;
	var envelope = Env.new([1,1,0],[engineTime *0.9, engineTime * 0.1]);
	Mix.ar([BrownNoise.ar(0.6 * EnvGen.ar(envelope)) , (BrownNoise.ar(LFPulse.ar(12)) * 0.4 * EnvGen.ar(envelope, doneAction:doneAction)) ])
};

~brake = {
	arg waitingTime = 3, noiseFunc = PinkNoise;
	var env, snd, env2, noise;
	env = Env.new([0,0,0.8,0],[waitingTime,0.001,1.42]);
	noise = noiseFunc.ar(EnvGen.ar(env));
	noise = LPF.ar(noise,5500);
	snd = Mix.ar([PMOsc.ar(3130, 124, 1.0, mul: 0.4), PMOsc.ar(2912, 124, 1.0, mul: 0.4), PMOsc.ar(3016, 124, 1.0, mul: 0.5), noise*0.6]);
	env2 = Env.new([0,0,0.5,1,0], [waitingTime,0.001,0.5,3],\wel);
	snd * EnvGen.ar(env2)
};

SynthDef(\carro,{
	var engine, brake, horns, envHorn, tmjmp = 0.1, tmshort = 0.54, output;
	envHorn = Env.new([0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0],
		[2,tmjmp,2.19,tmjmp,0.9,tmjmp,tmshort,tmjmp,tmshort,tmjmp,tmshort,tmjmp,tmshort,tmjmp,tmshort,tmjmp,tmshort,tmjmp,2.19,tmshort]);
	horns = ~horn.value(500,1,EnvGen.ar(envHorn));
	engine = ~engine.value(12,2);
	brake = ~brake.value(8, WhiteNoise);
	output = Mix.ar([horns,engine, brake]);
	Out.ar(0,Pan2.ar(output));
}).add;

/*
SONIDO GUITARRA
*/
SynthDef("plucking", {arg amp = 0.1, freq = 440, decay = 5, coef = 0.1;

var env, snd;
env = EnvGen.kr(Env.linen(0, decay, 0), doneAction: 2);
snd = Pluck.ar(
        in: WhiteNoise.ar(amp),
        trig: Impulse.kr(0),

        maxdelaytime: 0.1,
        delaytime: freq.reciprocal,
        decaytime: decay,
        coef: coef);
    Out.ar(0, [snd, snd]);
}).add;

/*
SONIDO SAX
*/
SynthDef(\sax, { |out, freq=440, amp=0.1, gate=1|
	var num = 16;
	var harms = Array.series(num, 1, 1) * Array.exprand(num, 0.995, 1.001);
	var snd = SinOsc.ar(freq * SinOsc.kr(Rand(2.0,5.0),0,Rand(0.001, 0.01),1) * harms, mul:Array.geom(num, 1, 0.63));
	snd = Splay.ar(snd);
	snd = BBandPass.ar(snd, freq * XLine.kr(0.1,4,0.01), 2);
	snd = snd * amp * EnvGen.ar(Env.adsr(0.001, 0.2, 0.7, 0.2), gate, doneAction:2);
	Out.ar(out, snd!2);
}).add;

)



( // Ejecucion

~t = Task({
Pbind(
    \instrument, "plucking",
	\freq, Pseq([
  52, 59, 64, 68, 59, 64, 68, 68, 52, 59, 64, 68, 68, 59, 64, 68, 68, 52, 59, 64, 68, 68, 59, 64, 68, 68, 52, 59, 64, 68, 68, 59, 64, 68, 68, 52, 59, 64, 68, 68, 59, 64, 68, 68, 52, 59, 64, 68, 68, 59, 64, 68, 68, 59, 71, 59, 68, 64, 68, 52, 59, 64, 68, 68, 52, 59, 64, 68, 68, 59, 59, 64, 68, 68, 52, 64, 59, 68, 68, 59, 71, 64, 76, 59, 71, 57, 69, 60, 72, 63, 75, 60, 72, 63, 75, 59, 71, 63, 75, 59, 59, 64, 68, 68, 71, 52, 59, 59, 64, 68, 68, 59, 59, 64, 68, 68, 52, 59, 64, 68, 59, 59, 64, 68, 68, 52, 59, 64, 68, 71, 59, 59, 64, 68, 68, 52, 64, 59, 68, 59, 64, 68, 63, 68, 72, 63, 68, 71, 63, 68, 52, 64, 59, 64, 68, 68, 59, 64, 69, 64, 69, 64, 69, 52, 64, 59, 64, 68, 68, 59, 59, 64, 68, 59, 63, 69, 63, 69, 62, 69, 66, 52, 59, 64, 59, 64, 68, 68, 59, 71, 64, 68, 68, 52, 64
].midicps),
	\mtranspose, -10,
    \amp, 0.2,
    \decay, Pwhite(6, 10),
    \coef, Pseq([0.6], inf),
    \dur, Pseq([
  0.3496500000000001, 0.34965, 0.34965, 0.34965, 0.3496499999999998, 0.3103143749999999, 0.3103143749999999, 0.100524375, 0.34965, 0.3103143749999999, 0.3103143749999999, 0.3103143749999999, 0.100524375, 0.34965000000000046, 0.31031437500000036, 0.31031437500000036, 0.100524375, 0.34965000000000046, 0.3103143749999999, 0.3103143749999999, 0.3103143749999999, 0.100524375, 0.34965000000000046, 0.3103143750000008, 0.3103143750000008, 0.100524375, 0.3496499999999996, 0.3103143749999999, 0.3103143749999999, 0.3103143749999999, 0.100524375, 0.3496499999999996, 0.3103143749999999, 0.3103143749999999, 0.100524375, 0.3496499999999996, 0.31031437499999903, 0.10052437500000089, 0.3496499999999987, 0.3496499999999987, 0.3496499999999987, 0.3496499999999987, 0.34965000000000046, 0.34965000000000046, 0.34965000000000046, 0.34965000000000046, 0.3103143750000008, 0.3103143750000008, 0.10052437500000089, 0.34965000000000224, 0.3103143750000026, 0.3103143750000026, 0.10052437500000089, 0.34965000000000046, 0.34965000000000046, 0.3103143750000008, 0.3103143750000008, 0.10052437499999911, 0.10052437499999911, 0.34965000000000046, 0.3103143750000008, 0.3103143750000008, 0.3103143750000008, 0.10052437499999911, 0.34965000000000046, 0.3103143750000008, 0.3103143750000008, 0.3103143750000008, 0.10052437499999911, 0.34965000000000046, 0.3103143750000008, 0.3103143750000008, 0.3103143750000008, 0.10052437499999911, 0.34965000000000046, 0.34965000000000046, 0.3103143750000008, 0.3103143750000008, 0.10052437500000266, 0.3103143750000008, 0.3103143750000008, 0.10052437500000266, 0.10052437500000266, 0.3103143750000008, 0.3103143750000008, 0.10052437500000266, 0.10052437500000266, 0.7342650000000006, 0.7342650000000006, 0.7342650000000006, 0.7342650000000006, 0.7342649999999971, 0.7342649999999971, 0.7342649999999971, 0.7342649999999971, 0.7342650000000006, 0.7342650000000006, 0.7342650000000006, 0.7342650000000006, 0.34965000000000046, 0.3103143750000008, 0.3103143750000008, 0.3103143750000008, 0.10052437499999911, 0.10052437499999911, 0.3496499999999969, 0.3496499999999969, 0.31031437499999726, 0.31031437499999726, 0.31031437499999726, 0.10052437499999911, 0.3496499999999969, 0.31031437499999726, 0.31031437499999726, 0.31031437499999726, 0.10052437499999911, 0.34965000000000046, 0.31031437499999726, 0.31031437499999726, 0.10052437499999911, 0.34965000000000046, 0.3103143750000008, 0.3103143750000008, 0.3103143750000008, 0.10052437499999911, 0.34965000000000046, 0.3103143750000008, 0.3103143750000008, 0.3103143750000008, 0.10052437499999911, 0.34965000000000046, 0.31031437499999726, 0.31031437499999726, 0.31031437499999726, 0.10052437499999911, 0.3496499999999969, 0.3496499999999969, 0.3496499999999969, 0.3496499999999969, 0.3496499999999969, 0.3496499999999969, 0.3496499999999969, 0.3496499999999969, 0.3496499999999969, 0.3496499999999969, 0.349650000000004, 0.349650000000004, 0.349650000000004, 0.7342650000000006, 0.7342650000000006, 0.3496499999999969, 0.3496499999999969, 0.31031437500000436, 0.31031437500000436, 0.31031437500000436, 0.10052437499999911, 0.7342650000000006, 0.3496499999999969, 0.3496499999999969, 0.3496499999999969, 0.3496499999999969, 0.7342650000000006, 0.7342650000000006, 0.3496499999999969, 0.3496499999999969, 0.31031437499999726, 0.31031437499999726, 0.31031437499999726, 0.10052437499999911, 0.3496499999999969, 0.3496499999999969, 0.3496499999999969, 0.3496499999999969, 0.3496499999999969, 0.3496499999999969, 0.3496499999999969, 0.3496499999999969, 0.3496499999999969, 0.31031437499999726, 0.31031437499999726, 0.10052437499999911, 0.349650000000004, 0.349650000000004, 0.349650000000004, 0.31031437499999726, 0.31031437499999726, 0.31031437499999726, 0.10052437499999911, 0.349650000000004, 0.349650000000004, 0.31031437499999726, 0.31031437499999726, 0.10052437499999911, 1.5734250000000003, 1.5734250000000003
]*1.5, inf)
).play;

4.125.wait;

Pbind(
    \instrument, "sax",
	\freq, Pseq([
  83, 80, 82, 83, 85, 83, 83, 82, 83, 85, 83, 76, 88, 83, 95, 82, 94, 83, 95, 85, 97, 83, 95, 83, 95, 82, 94, 83, 95, 85, 97, 83, 95, 76, 88, 63, 69, 63, 69, 63, 69, 69, 71, 69, 63, 69, 78, 63, 69, 69, 71, 63, 69, 63, 69, 78, 63, 69, 78, 71, 76, 71, 83, 70, 82, 71, 83, 73, 85, 71, 83, 76, 83, 76, 88, 80, 80, 78, 80, 78, 83, 76, 76, 71, 78, 73, 79, 79, 79, 78, 76, 71, 70, 71, 73, 71, 71, 70, 71, 73, 71, 75, 75, 76].midicps),
	\mtranspose, 1,
    \amp, 0.3,
    \decay, Pwhite(6, 10),
    \coef, Pseq([0.6], inf),
    \dur, Pseq([
  0.100524375,0.3103143749999999,0.10052437499999911,0.31031437499999903,0.10052437500000089,0.3496499999999987,0.3103143750000008,0.10052437499999911,0.31031437499999903,0.10052437499999911,0.3496499999999987,0.20541937499999996,0.20541937499999996,0.3103143750000008,0.3103143750000008,0.10052437500000089,0.10052437500000089,0.3103143750000008,0.3103143750000008,0.10052437500000089,0.10052437500000089,0.34965000000000224,0.34965000000000224,0.3103143750000008,0.3103143750000008,0.10052437499999911,0.10052437499999911,0.3103143750000008,0.3103143750000008,0.10052437499999911,0.10052437499999911,0.34965000000000046,0.34965000000000046,0.10052437500000266,0.10052437500000266,0.34965000000000046,0.34965000000000046,0.349650000000004,0.349650000000004,0.7342650000000006,0.349650000000004,0.31031437500000436,0.10052437500000266,0.34965000000000046,0.3103143750000008,0.3103143750000008,0.10052437500000266,0.7342649999999971,0.34965000000000046,0.3103143750000008,0.10052437500000266,0.34965000000000046,0.34965000000000046,0.3103143750000008,0.3103143750000008,0.10052437499999911,0.7342650000000006,0.34965000000000046,0.3103143750000008,0.45454499999999953,0.3103143750000008,0.31031437499999726,0.31031437499999726,0.10052437499999911,0.10052437499999911,0.31031437499999726,0.31031437499999726,0.10052437499999911,0.10052437499999911,0.34965000000000046,0.34965000000000046,0.3496499999999969,0.3496499999999969,0.3496499999999969,0.3496499999999969,0.31031437499999726,0.10052437499999911,0.31031437500000436,0.10052437499999911,0.3496499999999969,0.3496499999999969,0.349650000000004,0.3496499999999969,0.31031437499999726,0.10052437499999911,0.3496499999999969,0.3496499999999969,0.3496499999999969,0.31031437499999726,0.100524374999992,0.3496499999999969,0.31031437499999726,0.100524374999992,0.31031437499999726,0.10052437499999911,0.7342650000000006,0.31031437499999726,0.100524374999992,0.31031437499999726,0.10052437499999911,0.3496499999999969,0.31031437499999726,0.349650000000004,2.8321649999999963]*3, inf)
).play;

40.wait;

Synth(\carro).play;

}).play;

)



// probably stops
~t.stop;

// should pick up
~t.play;



















